#!/bin/sh
# Pre-commit hook to prevent secrets from being committed

echo "Running pre-commit secret detection..."

# Patterns to detect potential secrets (case-insensitive)
SECRET_PATTERNS=(
  "sk-[a-zA-Z0-9]{20,}"           # OpenAI API keys
  "pk_[a-zA-Z0-9]{20,}"           # Stripe publishable keys
  "rk_[a-zA-Z0-9]{20,}"           # Stripe restricted keys  
  "sk_live_[a-zA-Z0-9]{20,}"      # Stripe secret keys
  "AIza[a-zA-Z0-9]{35}"           # Google API keys
  "ghp_[a-zA-Z0-9]{36}"           # GitHub personal tokens
  "gho_[a-zA-Z0-9]{36}"           # GitHub OAuth tokens
  "glpat-[a-zA-Z0-9]{20}"         # GitLab tokens
  "xox[baprs]-[a-zA-Z0-9]{10,}"   # Slack tokens
  "-----BEGIN (RSA |EC |OPENSSH |DSA )?PRIVATE KEY-----"  # Private keys
  "AKIA[A-Z0-9]{16}"              # AWS access keys
  "password\s*[=:]\s*['\"][^'\"]{8,}['\"]"  # Hardcoded passwords
  "api[_-]?key\s*[=:]\s*['\"][^'\"]{16,}['\"]"  # API keys in config
  "secret\s*[=:]\s*['\"][^'\"]{16,}['\"]"  # Secrets in config
)

# Files to check (staged files only)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files to check."
  exit 0
fi

FOUND_SECRETS=0

for pattern in "${SECRET_PATTERNS[@]}"; do
  # Check staged files for secrets
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null || true)
  
  if [ -n "$MATCHES" ]; then
    echo "ERROR: Potential secret found matching pattern: $pattern"
    echo "In files:"
    echo "$MATCHES"
    FOUND_SECRETS=1
  fi
done

# Also check for .env files being committed
ENV_FILES=$(echo "$STAGED_FILES" | grep -E "\.env" || true)
if [ -n "$ENV_FILES" ]; then
  echo "ERROR: .env file being committed:"
  echo "$ENV_FILES"
  FOUND_SECRETS=1
fi

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "COMMIT BLOCKED: Potential secrets detected!"
  echo "Please review and remove secrets before committing."
  echo "If this is a false positive, you can bypass with: git commit --no-verify"
  exit 1
fi

echo "No secrets detected. Proceeding with commit."
exit 0
